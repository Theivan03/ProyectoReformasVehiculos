@if (mostrarPreseleccion) {
<div class="container mt-4">
  <div class="card p-4 shadow-sm">
    <h4 class="mb-3">Tipo de Vehículo</h4>
    <p class="text-muted mb-3">Elige una opción y pulsa “Siguiente”.</p>

    <div class="row g-3">
      <div class="col-6 col-md-3" *ngFor="let o of opcionesVehiculo">
        <div
          class="card h-100 text-center border-2"
          [ngClass]="{
            'border-primary shadow': tipoVehiculo === o.value,
            'border-light': tipoVehiculo !== o.value
          }"
          role="button"
          (click)="seleccionarTipoPrevia(o.value)"
        >
          <img
            [src]="o.img"
            class="card-img-top p-3 img-fluid"
            alt="{{ o.label }}"
          />
          <div class="card-body py-2">
            <div class="fw-semibold">{{ o.label }}</div>
          </div>
          <!-- Amplía el click -->
          <a class="stretched-link" tabindex="-1"></a>
        </div>
      </div>
    </div>

    <div class="text-danger mt-3" *ngIf="tipoVehiculoInvalido && !tipoVehiculo">
      Debe seleccionar un tipo de vehículo.
    </div>

    <div class="d-flex justify-content-end mt-4">
      <button
        class="btn btn-primary"
        (click)="irASiguientePaso()"
        [disabled]="!tipoVehiculo"
      >
        Siguiente →
      </button>
    </div>
  </div>
</div>
} @else {

<div class="container mt-4">
  <div class="card p-4 shadow-sm">
    <h4 class="mb-3">Tipo de Vehículo</h4>

    <!-- Selector tipo vehículo -->
    <div class="mb-3">
      <label class="form-label">Seleccione el tipo de vehículo:</label>
      <select
        class="form-select"
        [(ngModel)]="tipoVehiculo"
        (change)="onTipoCambio()"
        [class.is-invalid]="tipoVehiculoInvalido"
      >
        <option [ngValue]="null" disabled selected>-- Seleccionar --</option>
        <option value="coche">Coche</option>
        <option value="moto">Moto</option>
        <option value="camper">Camper</option>
        <option value="industrial">Industrial</option>
      </select>
      <div class="invalid-feedback">Debe seleccionar un tipo de vehículo.</div>
    </div>

    <!-- Lista de modificaciones -->
    @if (modificaciones.length > 0) {
    <div class="mt-4">
      <h5 class="mb-3">Modificaciones aplicables</h5>
      @for (mod of modificaciones; track mod; let i = $index) {
      <div class="mb-3">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            [(ngModel)]="mod.seleccionado"
            [id]="'mod-' + i"
          />
          <label class="form-check-label" [for]="'mod-' + i">
            {{ mod.nombre }}
          </label>
        </div>
        <!-- Muelles -->
        @if (mod.nombre.includes('MUELLES') && mod.seleccionado) {
        <div class="mt-2 ms-4">
          <label class="form-label">¿Qué elementos se han modificado?</label>
          @for (item of detallesMuellesOpciones; track item; let i = $index) {
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detallesMuelles![item.key]"
              (ngModelChange)="actualizarError(i, mod)"
              id="detalle-muelle-{{ i }}"
              name="detalle-muelle-{{ i }}"
            />
            <label class="form-check-label" for="detalle-muelle-{{ i }}">
              {{ item.label }}
            </label>
          </div>
          } @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
          <label class="form-label mt-3"
            >¿Desea añadir la anotación de no modificación de dirección?</label
          >
          <select
            class="form-select"
            [(ngModel)]="mod.anotacion"
            (ngModelChange)="actualizarError(i, mod)"
          >
            <option [ngValue]="null" disabled selected>
              -- Seleccionar --
            </option>
            <option value="1">Sí</option>
            <option value="2">No</option>
          </select>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- Neumáticos -->
        @if (mod.nombre === 'NEUMÁTICOS' && mod.seleccionado) {
        <div class="ms-4 mt-2">
          <label class="form-label">Seleccione anotaciones si procede:</label>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.anotacion1"
              (ngModelChange)="actualizarError(i, mod)"
              id="anotacion1{{ i }}"
            />
            <label class="form-check-label" for="anotacion1{{ i }}"
              >Diferencia superior al 8%</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.anotacion2"
              (ngModelChange)="actualizarError(i, mod)"
              id="anotacion2{{ i }}"
            />
            <label class="form-check-label" for="anotacion2{{ i }}"
              >Índice de velocidad menor del original</label
            >
          </div>
        </div>
        }
        <!-- INTERMITENTES -->
        @if (mod.nombre === 'INTERMITENTES' && mod.seleccionado) {
        <div class="ms-4">
          <label class="form-label"
            >Seleccione la posicion de los intermitentes:</label
          >
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.interDelantero"
              (ngModelChange)="actualizarError(i, mod)"
              id="interDelantero{{ i }}"
            />
            <label class="form-check-label" for="interDelantero{{ i }}"
              >Delanteros</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.interTrasero"
              (ngModelChange)="actualizarError(i, mod)"
              id="interTrasero{{ i }}"
            />
            <label class="form-check-label" for="interTrasero{{ i }}"
              >Traseros</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.interLateral"
              (ngModelChange)="actualizarError(i, mod)"
              id="interLateral{{ i }}"
            />
            <label class="form-check-label" for="interLateral{{ i }}"
              >Laterales</label
            >
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- SUSTITUCIÓN DE EJES -->
        @if (mod.nombre === 'SUSTITUCIÓN DE EJES' && mod.seleccionado) {
        <div mod.detalle class="ms-4">
          <label class="form-label">Seleccione el/los ejes:</label>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.sustitucionEjeDelantero"
              (ngModelChange)="actualizarError(i, mod)"
              id="sustitucionEjeDelantero{{ i }}"
            />
            <label class="form-check-label" for="sustitucionEjeDelantero{{ i }}"
              >Delantero</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.sustitucionEjeTrasero"
              (ngModelChange)="actualizarError(i, mod)"
              id="sustitucionEjeTrasero{{ i }}"
            />
            <label class="form-check-label" for="sustitucionEjeTrasero{{ i }}"
              >Trasero</label
            >
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- ESTRIBOS LATERALES O TALONERAS -->
        @if ( mod.nombre === 'ESTRIBOS LATERALES O TALONERAS' &&
        mod.seleccionado && mod.detalle) {
        <div class="ms-4 mt-2">
          <label class="form-label">Seleccione cuál instaló:</label>
          <select
            class="form-select mb-1"
            [(ngModel)]="mod.detalle.estribosotaloneras"
            (ngModelChange)="validarSubopciones()"
            [class.is-invalid]="erroresSubopciones[i]"
            name="estribosotaloneras{{ i }}"
            [ngModelOptions]="{ standalone: true }"
          >
            <option [ngValue]="null" disabled>-- Seleccionar --</option>
            <option value="estribos">Estribos</option>
            <option value="taloneras">Taloneras</option>
          </select>
          <label class="form-label">¿Material antideslizante?</label>
          <select
            class="form-select mb-1"
            [(ngModel)]="mod.detalle.anotacionAntideslizante"
            (ngModelChange)="validarSubopciones()"
            [class.is-invalid]="erroresSubopciones[i]"
            name="anotacionAntideslizante{{ i }}"
            [ngModelOptions]="{ standalone: true }"
          >
            <option [ngValue]="null" disabled>-- Seleccionar --</option>
            <option value="1">Sí</option>
            <option value="2">No</option>
          </select>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debes escoger ambas opciones antes de continuar.
          </div>
          }
        </div>
        }
        <!-- Aletines -->
        @if ( mod.nombre.includes('ALETINES') && mod.seleccionado && mod.detalle
        ) {
        <div class="ms-4">
          <label class="form-label">Seleccione el tipo:</label>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle.aletines"
              (ngModelChange)="actualizarError(i, mod)"
              id="aletines{{ i }}"
            />
            <label class="form-check-label" for="aletines{{ i }}"
              >Aletines</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle.sobrealetines"
              (ngModelChange)="actualizarError(i, mod)"
              id="sobrealetines{{ i }}"
            />
            <label class="form-check-label" for="sobrealetines{{ i }}"
              >Sobrealetines</label
            >
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- Matrícula -->
        @if ( mod.nombre.includes('MATRÍCULA') && mod.seleccionado &&
        mod.detalle ) {
        <div class="ms-4">
          <label class="form-label">Modificación de matrícula:</label>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="instalacionPorta{{ i }}"
              [(ngModel)]="mod.detalle.instalacionPorta"
              name="instalacionPorta{{ i }}"
            />
            <label class="form-check-label" for="instalacionPorta{{ i }}">
              Portamatrículas trasero
            </label>
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="reubicacionTrasera{{ i }}"
              [(ngModel)]="mod.detalle.reubicacionTrasera"
              name="reubicacionTrasera{{ i }}"
            />
            <label class="form-check-label" for="reubicacionTrasera{{ i }}">
              Reubicación matrícula trasera
            </label>
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="cambioUbicacionDelantera{{ i }}"
              [(ngModel)]="mod.detalle.cambioUbicacionDelantera"
              name="cambioUbicacionDelantera{{ i }}"
            />
            <label
              class="form-check-label"
              for="cambioUbicacionDelantera{{ i }}"
            >
              Cambio ubicación matrícula delantera
            </label>
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- Piloto trasero -->
        @if ( mod.nombre.includes('PILOTO TRASERO') && mod.seleccionado &&
        mod.detalle ) {
        <div class="ms-4">
          <label class="form-label">¿Qué elementos va a sustituir?</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="luzPosYFreno{{ i }}"
              [(ngModel)]="mod.detalle.luzPosicionFreno"
              name="luzPosicionFreno{{ i }}"
              (change)="actualizarError(i, mod)"
            />
            <label class="form-check-label" for="luzPosYFreno{{ i }}">
              Luz de posición y freno
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="intermitente{{ i }}"
              [(ngModel)]="mod.detalle.intermitente"
              name="intermitente{{ i }}"
              (ngModelChange)="actualizarError(i, mod)"
            />
            <label class="form-check-label" for="intermitente{{ i }}">
              Intermitente
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="marchaAtras{{ i }}"
              [(ngModel)]="mod.detalle.marchaAtras"
              name="marchaAtras{{ i }}"
              (ngModelChange)="actualizarError(i, mod)"
            />
            <label class="form-check-label" for="marchaAtras{{ i }}">
              Marcha atrás
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="catadioptrico{{ i }}"
              [(ngModel)]="mod.detalle.catadioptrico"
              name="catadioptrico{{ i }}"
              (ngModelChange)="actualizarError(i, mod)"
            />
            <label class="form-check-label" for="catadioptrico{{ i }}">
              Catadióptrico
            </label>
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- Mueble camper -->
        @if ( mod.nombre === 'MOBILIARIO INTERIOR VEHÍCULO' && mod.seleccionado
        && mod.opcionesMueble ) {
        <div class="ms-4">
          <label class="form-label">¿Qué tipo de mueble desea indicar?</label>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.opcionesMueble.muebleBajo"
              (ngModelChange)="actualizarError(i, mod)"
              id="muebleBajo{{ i }}"
            />
            <label class="form-check-label" for="muebleBajo{{ i }}"
              >Mueble bajo</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.opcionesMueble.muebleAlto"
              (ngModelChange)="actualizarError(i, mod)"
              id="muebleAlto{{ i }}"
            />
            <label class="form-check-label" for="muebleAlto{{ i }}"
              >Mueble alto</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.opcionesMueble.aseo"
              (ngModelChange)="actualizarError(i, mod)"
              id="aseo{{ i }}"
            />
            <label class="form-check-label" for="aseo{{ i }}">Aseo</label>
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- Instalación eléctrica camper -->
        @if (mod.nombre === 'INSTALACIÓN ELÉCTRICA' && mod.seleccionado) {
        <div class="ms-4">
          <label class="form-label">¿Desea añadir anotación?</label>
          <select class="form-select" [(ngModel)]="mod.anotacion">
            <option [ngValue]="null" disabled selected>
              -- Seleccionar --
            </option>
            <option [ngValue]="true">Sí</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>
        }
        <!-- Aumento o disminución de plazas -->
        @if ( mod.nombre === 'AUMENTO O DISMINUCIÓN DE PLAZAS' &&
        mod.seleccionado ) {
        <div class="ms-4">
          <label class="form-label">Tipo de modificación:</label>
          <select class="form-select" [(ngModel)]="mod.tipoCambio">
            <option [ngValue]="null" disabled selected>
              -- Seleccionar --
            </option>
            <option value="aumento">Aumento</option>
            <option value="disminucion">Disminución</option>
          </select>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- MMA/MMTA moto -->
        @if (mod.nombre === 'REDUCCIÓN MMA Y MMTA' && mod.seleccionado) {
        <div class="ms-4">
          <label class="form-label">¿Qué se modifica?</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.ejeDelantero"
              id="ejeDelantero{{ i }}"
            />
            <label class="form-check-label" for="ejeDelantero{{ i }}"
              >Reducción en eje delantero</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.ejeTotal"
              id="ejeTotal{{ i }}"
            />
            <label class="form-check-label" for="ejeTotal{{ i }}"
              >Reducción total</label
            >
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- Guardabarros -->
        @if (mod.nombre === 'SUSTITUCIÓN GUARDABARROS' && mod.seleccionado) {
        <div class="ms-4">
          <label class="form-label">¿Qué guardabarros se ha sustituido?</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.guardabarrosDelantero"
              id="guardabarrosDelantero{{ i }}"
            />
            <label class="form-check-label" for="guardabarrosDelantero{{ i }}"
              >Delantero</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.guardabarrosTrasero"
              id="guardabarrosTrasero{{ i }}"
            />
            <label class="form-check-label" for="guardabarrosTrasero{{ i }}"
              >Trasero</label
            >
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- Disco y pastilla de freno -->
        @if ( mod.nombre === 'DISCO DE FRENO Y PINZA DE FRENO' &&
        mod.seleccionado ) {
        <div class="ms-4">
          <label class="form-label"
            >¿Qué componente de freno se ha modificado?</label
          >
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.tieneDisco"
              id="ejeDelantero{{ i }}"
            />
            <label class="form-check-label" for="ejeDelantero{{ i }}"
              >Disco de freno</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.tienePastilla"
              id="tienePastilla{{ i }}"
            />
            <label class="form-check-label" for="tienePastilla{{ i }}"
              >Pastilla de freno</label
            >
          </div>
          @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
        <!-- Luces -->
        @if (mod.nombre === 'LUCES' && mod.seleccionado) {
        <div class="mt-3 ms-4 border-start ps-3">
          <label class="form-label">
            ¿Qué modificaciones se han hecho en luces?
          </label>
          @for (item of opcionesDescripcionLuces; track item; let i = $index) {
          <div class="form-check mb-1">
            <input
              type="checkbox"
              class="form-check-input"
              id="luces-{{ i }}"
              [(ngModel)]="mod.descripcionLuces![item.key]"
            />
            <label class="form-check-label" [for]="'luces-' + i">
              {{ item.label }}
            </label>
          </div>
          } @if (erroresSubopciones[i]) {
          <div class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
          }
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- Botones -->
    <div class="d-flex justify-content-between mt-4">
      <button class="btn btn-outline-secondary" (click)="volverFormulario()">
        ← Volver
      </button>
      <button class="btn btn-primary" (click)="continuarFormulario()">
        Continuar →
      </button>
    </div>
  </div>
</div>
}
