<style>
  @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;600;800&family=Roboto:wght@300;400;500&display=swap");

  .ing-form-scope {
    --font-tech: "JetBrains Mono", monospace;
    --font-reading: "Roboto", sans-serif;
    --color-accent: #0066ff;
    --color-success: #198754;
    --color-border: #dee2e6;
    --color-bg-input: #f8f9fa;
  }

  .ing-form-scope * {
    border-radius: 0 !important;
  }

  .ing-section-title {
    font-family: var(--font-tech);
    text-transform: uppercase;
    font-weight: 800;
    border-bottom: 2px solid #000;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 1.1rem;
    color: #000;
  }

  .ing-label-tech {
    font-family: var(--font-tech);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.8rem;
    color: #495057;
    margin-bottom: 0.5rem;
    display: block;
    letter-spacing: -0.5px;
  }

  .ing-card-tech {
    border: 1px solid var(--color-border);
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .ing-card-header {
    background-color: #fff;
    border-bottom: 1px solid var(--color-border);
    padding: 0.5rem 1rem;
  }

  .ing-badge {
    font-family: var(--font-tech);
    text-transform: uppercase;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.35em 0.65em;
    background-color: #e9ecef;
    color: #495057;
  }

  .ing-dropzone {
    background-color: var(--color-bg-input);
    border: 2px dashed #ced4da;
    transition: all 0.2s ease;
  }

  .ing-dropzone:hover {
    background-color: #fff;
    border-color: var(--color-accent);
  }

  .btn-ing-success {
    background-color: var(--color-success);
    border-color: var(--color-success);
    color: #fff;
    font-family: var(--font-tech);
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 0.5rem 1.5rem;
  }

  .btn-ing-success:hover {
    background-color: #146c43;
    border-color: #146c43;
  }

  .btn-ing-outline {
    background-color: transparent;
    border: 2px solid #6c757d;
    color: #6c757d;
    font-family: var(--font-tech);
    text-transform: uppercase;
    font-weight: 700;
  }

  .btn-ing-outline:hover {
    background-color: #6c757d;
    color: #fff;
  }

  .btn-ing-action {
    font-family: var(--font-tech);
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: 600;
  }
</style>

<div class="ing-form-scope container mt-4 mb-5">
  <div class="card border border-light-subtle shadow-sm bg-white p-4 p-lg-5">
    <h5 class="ing-section-title mt-0">
      <span class="text-muted me-2">Paso {{ step }} / 3</span>
      {{
        step === 1
          ? "EXTERIOR DEL VEHÍCULO"
          : step === 2
          ? "REFORMAS Y MODIFICACIONES"
          : "DOCUMENTACIÓN TÉCNICA"
      }}
    </h5>

    <ng-container *ngIf="step === 1">
      <p class="mb-4" style="font-family: var(--font-reading)">
        Sube las imágenes <strong>previas</strong> del vehículo para establecer
        el estado inicial.
      </p>

      <div class="row row-cols-1 row-cols-md-2 g-4 mb-5">
        <div
          class="col"
          *ngFor="
            let label of [
              'Frontal',
              'Trasera',
              'Lateral izquierdo',
              'Lateral derecho'
            ];
            let i = index
          "
        >
          <div class="card h-100 shadow-sm border bg-white">
            <div class="card-body d-flex flex-column p-3">
              <div class="mb-3">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span
                    class="badge bg-dark rounded-0"
                    style="font-family: var(--font-tech)"
                  >
                    VISTA {{ i + 1 }}
                  </span>
                  <h6
                    class="fw-bold text-primary mb-0 text-uppercase"
                    style="font-size: 0.9rem"
                  >
                    {{ label }}
                  </h6>
                </div>

                <div class="bg-light border text-center p-2">
                  <ng-container [ngSwitch]="label">
                    <img
                      *ngSwitchCase="'Frontal'"
                      src="../../../assets/delanteravehiculo.png"
                      class="img-fluid object-fit-contain"
                      style="height: 250px; width: 100%"
                    />
                    <img
                      *ngSwitchCase="'Trasera'"
                      src="../../../assets/traseravehiculo.png"
                      class="img-fluid object-fit-contain"
                      style="height: 250px; width: 100%"
                    />
                    <img
                      *ngSwitchCase="'Lateral izquierdo'"
                      src="../../../assets/izquierdavehiculo.jpg"
                      class="img-fluid object-fit-contain"
                      style="height: 250px; width: 100%"
                    />
                    <img
                      *ngSwitchCase="'Lateral derecho'"
                      src="../../../assets/derechavehiculo.jpg"
                      class="img-fluid object-fit-contain"
                      style="height: 250px; width: 100%"
                    />
                    <img
                      *ngSwitchDefault
                      src="assets/ejemplos/frontal.jpg"
                      class="img-fluid object-fit-contain"
                      style="height: 250px; width: 100%"
                    />
                  </ng-container>
                </div>
              </div>

              <div class="flex-grow-1 border-top pt-3">
                <input
                  #galleryInputs
                  type="file"
                  accept="image/*"
                  class="d-none"
                  (change)="onPrevSelected($event, i)"
                />
                <input
                  #cameraInputs
                  type="file"
                  accept="image/*"
                  capture="environment"
                  class="d-none"
                  (change)="onPrevSelected($event, i)"
                />

                <ng-container *ngIf="prevPreviews[i]; else botonesGrandes">
                  <div
                    class="position-relative bg-light border p-1"
                    style="min-height: 150px"
                  >
                    <img
                      [src]="prevPreviews[i]"
                      class="w-100 object-fit-contain"
                      style="height: 180px; display: block"
                    />

                    <button
                      type="button"
                      class="btn btn-danger position-absolute top-0 end-0 rounded-0 d-flex align-items-center justify-content-center shadow"
                      style="width: 32px; height: 32px; margin: 5px"
                      (click)="openInput('camera', 1, i)"
                      title="Cambiar imagen"
                    >
                      <i class="bi bi-x-lg">X</i>
                    </button>

                    <div
                      class="text-center bg-success text-white py-1 mt-1"
                      style="font-size: 0.7rem; font-family: var(--font-tech)"
                    >
                      VISTA REGISTRADA
                    </div>
                  </div>
                </ng-container>

                <ng-template #botonesGrandes>
                  <div
                    class="d-flex w-100 gap-2 h-100 align-items-end"
                    style="min-height: 100px"
                  >
                    <button
                      class="btn btn-outline-dark flex-grow-1 py-3"
                      (click)="openInput('gallery', 1, i)"
                    >
                      <i class="bi bi-folder2-open fs-4 d-block mb-1"></i>
                      <span class="small fw-bold">GALERÍA</span>
                    </button>
                    <button
                      class="btn btn-outline-dark flex-grow-1 py-3"
                      (click)="openInput('camera', 1, i)"
                    >
                      <i class="bi bi-camera fs-4 d-block mb-1"></i>
                      <span class="small fw-bold">CÁMARA</span>
                    </button>
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="d-flex justify-content-between align-items-center pt-3 border-top"
      >
        <button class="btn btn-ing-outline" (click)="back()">
          <i class="bi bi-arrow-left me-2"></i> Anterior
        </button>
        <button class="btn btn-ing-success" (click)="next()">
          Siguiente <i class="bi bi-arrow-right ms-2"></i>
        </button>
      </div>
    </ng-container>

    <ng-container *ngIf="step === 2">
      <div
        class="d-flex flex-wrap align-items-center justify-content-between mb-4"
      >
        <p class="mb-0" style="font-family: var(--font-reading)">
          Sube las imágenes de las reformas realizadas.
        </p>
        <span class="ing-badge bg-dark text-white">
          Total: {{ postImagesB64.length }}/{{ totalSlots }}
        </span>
      </div>

      <div class="d-flex flex-column gap-4 mb-5">
        <div
          class="ing-card-tech p-0"
          *ngFor="let mod of modsSeleccionadas; let i = index"
        >
          <div
            class="ing-card-header bg-light d-flex flex-wrap align-items-center gap-3"
          >
            <h6
              class="ing-label-tech mb-0 me-auto"
              style="font-size: 0.9rem; color: #000"
            >
              {{ tituloMod(mod.nombre) }}
            </h6>

            <button
              class="btn btn-outline-danger btn-sm btn-ing-action"
              (click)="openConfirmRemove(mod)"
            >
              <i class="bi bi-trash me-1"></i> Eliminar
            </button>

            <ng-container *ngIf="subopcionesPosibles(mod).length > 0">
              <div class="dropdown">
                <button
                  class="btn btn-outline-dark btn-sm dropdown-toggle btn-ing-action"
                  type="button"
                  data-bs-toggle="dropdown"
                >
                  Especificar Subselección
                </button>
                <ul class="dropdown-menu rounded-0 shadow p-0">
                  <li
                    *ngFor="let so of subopcionesPosibles(mod)"
                    class="border-bottom"
                  >
                    <label
                      class="d-flex align-items-center gap-2 px-3 py-2 cursor-pointer dropdown-item"
                    >
                      <input
                        #cb
                        type="checkbox"
                        class="form-check-input mt-0"
                        [checked]="isSubopcionActiva(mod, so.key)"
                        (change)="toggleSubopcion(mod, so.key, cb.checked)"
                        style="width: 1.2em; height: 1.2em"
                      />
                      <span
                        style="
                          font-family: var(--font-reading);
                          font-size: 0.9rem;
                        "
                      >
                        {{ tituloSub(mod.nombre, so.key) }}
                      </span>
                    </label>
                  </li>
                </ul>
              </div>
            </ng-container>
          </div>

          <div class="p-3">
            <div class="d-flex flex-column gap-5">
              <ng-container *ngFor="let soKey of subopcionesActivas(mod)">
                <div>
                  <div
                    class="d-flex justify-content-between align-items-end mb-3 border-bottom border-2 pb-2"
                  >
                    <h5 class="ing-label-tech text-dark mb-0 fs-6">
                      {{ tituloSub(mod.nombre, soKey) }}
                    </h5>
                    <button
                      class="btn btn-link text-danger p-0 text-decoration-none fw-bold"
                      style="font-family: var(--font-tech); font-size: 0.75rem"
                      (click)="openConfirmRemoveSub(mod, soKey)"
                    >
                      [ ELIMINAR GRUPO ]
                    </button>
                  </div>

                  <div class="row row-cols-1 row-cols-md-2 g-4">
                    <div
                      class="col"
                      *ngFor="
                        let ex of visibleExamplesFor(mod, soKey);
                        let i = index
                      "
                    >
                      <div class="card h-100 shadow-sm border bg-white">
                        <div class="card-body d-flex flex-column p-3">
                          <div class="mb-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                              <span
                                class="badge bg-dark rounded-0"
                                style="font-family: var(--font-tech)"
                                >{{ i + 1 }}</span
                              >
                              <h6
                                class="fw-bold text-primary mb-0 text-uppercase"
                                style="font-size: 0.9rem; line-height: 1.2"
                              >
                                {{ ex.label || "Detalle Requerido " + (i + 1) }}
                              </h6>
                            </div>

                            <div class="bg-light border text-center p-2">
                              <img
                                [src]="ex.src"
                                class="img-fluid object-fit-contain"
                                style="height: 250px; width: 100%"
                                [alt]="ex.label"
                              />
                            </div>
                          </div>

                          <div class="flex-grow-1 border-top pt-3">
                            <input
                              #singleGallery
                              type="file"
                              accept="image/*"
                              class="d-none"
                              (change)="
                                onSelectedForIndex($event, mod, soKey, i)
                              "
                            />
                            <input
                              #singleCamera
                              type="file"
                              accept="image/*"
                              capture="environment"
                              class="d-none"
                              (change)="
                                onSelectedForIndex($event, mod, soKey, i)
                              "
                            />

                            <ng-container
                              *ngIf="
                                getPreviewAt(mod, soKey, i) as userImg;
                                else botonesGrandes
                              "
                            >
                              <div
                                class="position-relative bg-light border p-1"
                                style="min-height: 150px"
                              >
                                <img
                                  [src]="userImg"
                                  class="w-100 object-fit-contain"
                                  style="height: 180px; display: block"
                                />

                                <button
                                  type="button"
                                  class="btn btn-danger position-absolute top-0 end-0 rounded-0 d-flex align-items-center justify-content-center shadow"
                                  style="width: 32px; height: 32px; margin: 5px"
                                  (click)="removeImageAtIndex(mod, soKey, i)"
                                >
                                  <i class="bi bi-x-lg">X</i>
                                </button>

                                <div
                                  class="text-center bg-success text-white py-1 mt-1"
                                  style="
                                    font-size: 0.7rem;
                                    font-family: var(--font-tech);
                                  "
                                >
                                  IMAGEN ADJUNTADA CORRECTAMENTE
                                </div>
                              </div>
                            </ng-container>

                            <ng-template #botonesGrandes>
                              <div
                                class="d-flex w-100 gap-2 h-100 align-items-end"
                              >
                                <button
                                  class="btn btn-outline-dark flex-grow-1 py-3"
                                  (click)="singleGallery.click()"
                                >
                                  <i
                                    class="bi bi-folder2-open fs-4 d-block mb-1"
                                  ></i>
                                  <span class="small fw-bold">GALERÍA</span>
                                </button>
                                <button
                                  class="btn btn-outline-dark flex-grow-1 py-3"
                                  (click)="singleCamera.click()"
                                >
                                  <i class="bi bi-camera fs-4 d-block mb-1"></i>
                                  <span class="small fw-bold">CÁMARA</span>
                                </button>
                              </div>
                            </ng-template>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>

      <div
        class="d-flex justify-content-between align-items-center pt-3 border-top"
      >
        <button class="btn btn-ing-outline" (click)="back()">
          <i class="bi bi-arrow-left me-2"></i> Anterior
        </button>
        <button class="btn btn-ing-success" (click)="next()">
          Siguiente <i class="bi bi-arrow-right ms-2"></i>
        </button>
      </div>
    </ng-container>

    <ng-container *ngIf="step === 3">
      <div
        class="alert alert-light border border-dark rounded-0 mb-4 d-flex align-items-center"
      >
        <i class="bi bi-info-circle-fill me-3 fs-4"></i>
        <div>
          <strong class="text-uppercase" style="font-family: var(--font-tech)"
            >Nota Informativa:</strong
          >
          <div class="small">
            No es obligatorio adjuntar documentación en este paso para
            continuar.
          </div>
        </div>
      </div>

      <div class="row row-cols-1 row-cols-md-2 g-4 mb-5">
        <div
          class="col"
          *ngFor="
            let doc of [
              'Ficha Tecnica',
              'Permiso De Circulacion',
              'Ticket De Peso',
              'Documentacion Adicional'
            ];
            let i = index
          "
        >
          <div class="card h-100 shadow-sm border bg-white">
            <div class="card-body d-flex flex-column p-3">
              <div class="mb-3">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span
                    class="badge bg-dark rounded-0"
                    style="font-family: var(--font-tech)"
                    >DOC {{ i + 1 }}</span
                  >
                  <h6
                    class="fw-bold text-primary mb-0 text-uppercase"
                    style="font-size: 0.9rem"
                  >
                    {{ doc }}
                  </h6>
                </div>

                <div class="bg-light border text-center p-2">
                  <ng-container [ngSwitch]="doc">
                    <div
                      *ngSwitchCase="'Ficha Tecnica'"
                      class="d-flex gap-1 justify-content-center"
                    >
                      <img
                        src="../../../assets/fichatecnica1.png"
                        class="border bg-white img-fluid object-fit-contain"
                        style="height: 200px; width: 48%"
                      />
                      <img
                        src="../../../assets/fichatecnica2.png"
                        class="border bg-white img-fluid object-fit-contain"
                        style="height: 200px; width: 48%"
                      />
                    </div>
                    <img
                      *ngSwitchCase="'Permiso De Circulacion'"
                      src="../../../assets/permisodecirculacionvehiculo.png"
                      class="border bg-white img-fluid object-fit-contain"
                      style="height: 200px; width: 48%"
                    />
                    <div
                      *ngSwitchCase="'Ticket De Peso'"
                      class="d-flex gap-1 justify-content-center"
                    >
                      <img
                        src="../../../assets/ticketpeso1.png"
                        class="border bg-white img-fluid object-fit-contain"
                        style="height: 200px; width: 48%"
                      />
                      <img
                        src="../../../assets/ticketpeso2.png"
                        class="border bg-white img-fluid object-fit-contain"
                        style="height: 200px; width: 48%"
                      />
                    </div>
                    <div
                      *ngSwitchDefault
                      class="text-muted py-4 small font-monospace"
                    >
                      DOCUMENTO GENERAL
                    </div>
                  </ng-container>
                </div>
              </div>

              <div class="flex-grow-1 border-top pt-3">
                <input
                  #galleryInputsDocs
                  type="file"
                  accept="image/*"
                  multiple
                  class="d-none"
                  (change)="onDocSelected($event, doc, 'gallery')"
                />
                <input
                  #cameraInputsDocs
                  type="file"
                  accept="image/*"
                  capture="environment"
                  multiple
                  class="d-none"
                  (change)="onDocSelected($event, doc, 'camera')"
                />

                <div
                  *ngIf="docError[doc]"
                  class="alert alert-danger rounded-0 py-1 px-2 mb-2 small text-uppercase font-monospace"
                >
                  {{ docError[doc] }}
                </div>

                <ng-container
                  *ngIf="
                    docsPreviews[doc] && docsPreviews[doc].length > 0;
                    else botonesGrandesDocs
                  "
                >
                  <div class="d-flex flex-column gap-3">
                    <div
                      *ngFor="let preview of docsPreviews[doc]; let j = index"
                      class="position-relative bg-light border p-1"
                    >
                      <img
                        [src]="preview"
                        class="w-100 object-fit-contain"
                        style="height: 180px; display: block"
                      />
                      <button
                        type="button"
                        class="btn btn-danger position-absolute top-0 end-0 rounded-0 d-flex align-items-center justify-content-center shadow"
                        style="width: 32px; height: 32px; margin: 5px"
                        (click)="removeDocImage(doc, j)"
                      >
                        <i class="bi bi-x-lg">X</i>
                      </button>
                      <div
                        class="text-center bg-success text-white py-1 mt-1"
                        style="font-size: 0.7rem; font-family: var(--font-tech)"
                      >
                        PÁGINA {{ j + 1 }} ADJUNTADA
                      </div>
                    </div>

                    <button
                      *ngIf="docsPreviews[doc].length < 4"
                      class="btn btn-outline-dark btn-sm w-100 py-2 text-uppercase fw-bold"
                      style="font-family: var(--font-tech)"
                      (click)="openInput('camera', 3, i)"
                    >
                      <i class="bi bi-plus-circle me-2"></i> Añadir otra página
                    </button>
                  </div>
                </ng-container>

                <ng-template #botonesGrandesDocs>
                  <div
                    class="d-flex w-100 gap-2 h-100 align-items-end"
                    style="min-height: 100px"
                  >
                    <button
                      class="btn btn-outline-dark flex-grow-1 py-3"
                      (click)="openInput('gallery', 3, i)"
                    >
                      <i class="bi bi-folder2-open fs-4 d-block mb-1"></i>
                      <span class="small fw-bold">GALERÍA</span>
                    </button>
                    <button
                      class="btn btn-outline-dark flex-grow-1 py-3"
                      (click)="openInput('camera', 3, i)"
                    >
                      <i class="bi bi-camera fs-4 d-block mb-1"></i>
                      <span class="small fw-bold">CÁMARA</span>
                    </button>
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="d-flex justify-content-between align-items-center pt-3 border-top"
      >
        <button class="btn btn-ing-outline" (click)="back()">
          <i class="bi bi-arrow-left me-2"></i> Anterior
        </button>
        <button
          class="btn btn-ing-success d-flex align-items-center gap-2"
          (click)="onSave()"
        >
          Guardar Imágenes <i class="bi bi-check-lg"></i>
        </button>
      </div>
    </ng-container>
  </div>
</div>

<div
  class="modal fade"
  id="modalQuitarReforma"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-0 shadow-lg">
      <div
        class="modal-header rounded-0 text-white"
        [ngClass]="modalAction === 'mod' ? 'bg-danger' : 'bg-warning'"
      >
        <h5
          class="modal-title text-uppercase"
          style="font-family: var(--font-tech)"
        >
          {{
            modalAction === "mod" ? "Eliminar Reforma" : "Eliminar Subselección"
          }}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body text-center p-4">
        <ng-container *ngIf="modalAction === 'mod'; else subMsg">
          <p class="mb-2">
            Vas a eliminar la siguiente reforma y sus imágenes:
          </p>
          <h5 class="ing-section-title border-bottom-0 mb-0 text-danger">
            {{ modParaQuitar?.nombre }}
          </h5>
        </ng-container>

        <ng-template #subMsg>
          <p class="mb-2">Vas a eliminar la subselección:</p>
          <h5 class="ing-section-title border-bottom-0 mb-0 text-warning">
            {{ modParaQuitar?.nombre }}
          </h5>
          <p class="fw-bold mt-2">
            {{
              subParaQuitarKey
                ? tituloSub(modParaQuitar?.nombre, subParaQuitarKey)
                : ""
            }}
          </p>
        </ng-template>
      </div>

      <div class="modal-footer justify-content-center bg-light rounded-0">
        <button
          type="button"
          class="btn btn-outline-secondary rounded-0 px-4"
          data-bs-dismiss="modal"
        >
          CANCELAR
        </button>
        <button
          type="button"
          class="btn rounded-0 px-4 fw-bold text-uppercase"
          [ngClass]="modalAction === 'mod' ? 'btn-danger' : 'btn-warning'"
          (click)="confirmRemove()"
          data-bs-dismiss="modal"
        >
          CONFIRMAR
        </button>
      </div>
    </div>
  </div>
</div>
