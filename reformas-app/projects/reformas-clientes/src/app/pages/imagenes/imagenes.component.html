<style>
  @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;600;800&family=Roboto:wght@300;400;500&display=swap");

  .ing-form-scope {
    --font-tech: "JetBrains Mono", monospace;
    --font-reading: "Roboto", sans-serif;
    --color-accent: #0066ff;
    --color-success: #198754;
    --color-border: #dee2e6;
    --color-bg-input: #f8f9fa;
  }

  .ing-form-scope * {
    border-radius: 0 !important;
  }

  .ing-section-title {
    font-family: var(--font-tech);
    text-transform: uppercase;
    font-weight: 800;
    border-bottom: 2px solid #000;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 1.1rem;
    color: #000;
  }

  .ing-label-tech {
    font-family: var(--font-tech);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.8rem;
    color: #495057;
    margin-bottom: 0.5rem;
    display: block;
    letter-spacing: -0.5px;
  }

  .ing-card-tech {
    border: 1px solid var(--color-border);
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .ing-card-header {
    background-color: #fff;
    border-bottom: 1px solid var(--color-border);
    padding: 0.5rem 1rem;
  }

  .ing-badge {
    font-family: var(--font-tech);
    text-transform: uppercase;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.35em 0.65em;
    background-color: #e9ecef;
    color: #495057;
  }

  .ing-dropzone {
    background-color: var(--color-bg-input);
    border: 2px dashed #ced4da;
    transition: all 0.2s ease;
  }

  .ing-dropzone:hover {
    background-color: #fff;
    border-color: var(--color-accent);
  }

  .btn-ing-success {
    background-color: var(--color-success);
    border-color: var(--color-success);
    color: #fff;
    font-family: var(--font-tech);
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 0.5rem 1.5rem;
  }

  .btn-ing-success:hover {
    background-color: #146c43;
    border-color: #146c43;
  }

  .btn-ing-outline {
    background-color: transparent;
    border: 2px solid #6c757d;
    color: #6c757d;
    font-family: var(--font-tech);
    text-transform: uppercase;
    font-weight: 700;
  }

  .btn-ing-outline:hover {
    background-color: #6c757d;
    color: #fff;
  }

  .btn-ing-action {
    font-family: var(--font-tech);
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: 600;
  }
</style>

<div class="ing-form-scope container mt-4 mb-5">
  <div class="card border border-light-subtle shadow-sm bg-white p-4 p-lg-5">
    <h5 class="ing-section-title mt-0">
      <span class="text-muted me-2">Paso {{ step }} / 3</span>
      {{
        step === 1
          ? "EXTERIOR DEL VEH칈CULO"
          : step === 2
          ? "REFORMAS Y MODIFICACIONES"
          : "DOCUMENTACI칍N T칄CNICA"
      }}
    </h5>

    <ng-container *ngIf="step === 1">
      <p class="mb-4" style="font-family: var(--font-reading)">
        Sube las im치genes <strong>previas</strong> del veh칤culo para establecer
        el estado inicial.
      </p>

      <div class="row row-cols-1 row-cols-md-2 g-4 mb-5">
        <div
          class="col"
          *ngFor="
            let label of [
              'Frontal',
              'Trasera',
              'Lateral izquierdo',
              'Lateral derecho'
            ];
            let i = index
          "
        >
          <div class="ing-card-tech h-100 d-flex flex-column">
            <div
              class="ing-card-header d-flex justify-content-between align-items-center"
            >
              <span class="ing-label-tech mb-0">{{ label }}</span>
              <span class="ing-badge">VISTA {{ i + 1 }}</span>
            </div>

            <div class="p-3 flex-grow-1">
              <div class="text-center mb-3 p-2 bg-light border">
                <ng-container [ngSwitch]="label">
                  <img
                    *ngSwitchCase="'Frontal'"
                    src="../../../assets/delanteravehiculo.png"
                    class="img-fluid object-fit-contain"
                    style="max-height: 150px"
                    alt="Ref Frontal"
                  />
                  <img
                    *ngSwitchCase="'Trasera'"
                    src="../../../assets/traseravehiculo.png"
                    class="img-fluid object-fit-contain"
                    style="max-height: 150px"
                    alt="Ref Trasera"
                  />
                  <img
                    *ngSwitchCase="'Lateral izquierdo'"
                    src="../../../assets/izquierdavehiculo.jpg"
                    class="img-fluid object-fit-contain"
                    style="max-height: 150px"
                    alt="Ref Izquierda"
                  />
                  <img
                    *ngSwitchCase="'Lateral derecho'"
                    src="../../../assets/derechavehiculo.jpg"
                    class="img-fluid object-fit-contain"
                    style="max-height: 150px"
                    alt="Ref Derecha"
                  />
                  <img
                    *ngSwitchDefault
                    src="assets/ejemplos/frontal.jpg"
                    class="img-fluid object-fit-contain"
                    style="max-height: 150px"
                    alt="Ref Default"
                  />
                </ng-container>
                <small
                  class="d-block mt-1 text-muted"
                  style="font-family: var(--font-tech); font-size: 0.65rem"
                  >REFERENCIA VISUAL</small
                >
              </div>

              <div class="d-grid gap-2 d-flex justify-content-center mb-3">
                <button
                  type="button"
                  class="btn btn-outline-dark btn-sm btn-ing-action"
                  (click)="openInput('gallery', 1, i)"
                >
                  <i class="bi bi-folder2-open me-1"></i> Galer칤a
                </button>
                <input
                  #galleryInputs
                  type="file"
                  accept="image/*"
                  class="d-none"
                  (change)="onPrevSelected($event, i)"
                />

                <button
                  type="button"
                  class="btn btn-outline-dark btn-sm btn-ing-action"
                  (click)="openInput('camera', 1, i)"
                >
                  <i class="bi bi-camera me-1"></i> C치mara
                </button>
                <input
                  #cameraInputs
                  type="file"
                  accept="image/*"
                  capture="environment"
                  class="d-none"
                  (change)="onPrevSelected($event, i)"
                />
              </div>

              <ng-container *ngIf="prevPreviews[i]; else dropPrevio">
                <div class="border p-1 bg-white">
                  <img
                    [src]="prevPreviews[i]"
                    class="img-fluid d-block mx-auto"
                    style="max-height: 200px; object-fit: contain"
                    [alt]="'preview ' + label"
                  />
                </div>
              </ng-container>

              <ng-template #dropPrevio>
                <div
                  class="ing-dropzone d-flex align-items-center justify-content-center p-4 text-center"
                  style="min-height: 120px"
                >
                  <span
                    class="text-muted"
                    style="font-family: var(--font-tech); font-size: 0.75rem"
                  >
                    [ SIN IMAGEN ]
                  </span>
                </div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>

      <div
        class="d-flex justify-content-between align-items-center pt-3 border-top"
      >
        <button class="btn btn-ing-outline" (click)="back()">
          <i class="bi bi-arrow-left me-2"></i> Anterior
        </button>
        <button
          class="btn btn-ing-success"
          [disabled]="isValidPreview(prevPreviews) < 4"
          (click)="next()"
        >
          Siguiente <i class="bi bi-arrow-right ms-2"></i>
        </button>
      </div>
    </ng-container>

    <ng-container *ngIf="step === 2">
      <div
        class="d-flex flex-wrap align-items-center justify-content-between mb-4"
      >
        <p class="mb-0" style="font-family: var(--font-reading)">
          Sube las im치genes de las reformas realizadas.
        </p>
        <span class="ing-badge bg-dark text-white">
          Total: {{ postImagesB64.length }}/{{ totalSlots }}
        </span>
      </div>

      <div class="d-flex flex-column gap-4 mb-5">
        <div
          class="ing-card-tech p-0"
          *ngFor="let mod of modsSeleccionadas; let i = index"
        >
          <div
            class="ing-card-header bg-light d-flex flex-wrap align-items-center gap-3"
          >
            <h6
              class="ing-label-tech mb-0 me-auto"
              style="font-size: 0.9rem; color: #000"
            >
              {{ tituloMod(mod.nombre) }}
            </h6>

            <button
              class="btn btn-outline-danger btn-sm btn-ing-action"
              (click)="openConfirmRemove(mod)"
            >
              <i class="bi bi-trash me-1"></i> Eliminar
            </button>

            <ng-container *ngIf="subopcionesPosibles(mod).length > 0">
              <div class="dropdown">
                <button
                  class="btn btn-outline-dark btn-sm dropdown-toggle btn-ing-action"
                  type="button"
                  data-bs-toggle="dropdown"
                >
                  Especificar Subselecci칩n
                </button>
                <ul class="dropdown-menu rounded-0 shadow p-0">
                  <li
                    *ngFor="let so of subopcionesPosibles(mod)"
                    class="border-bottom"
                  >
                    <label
                      class="d-flex align-items-center gap-2 px-3 py-2 cursor-pointer dropdown-item"
                    >
                      <input
                        #cb
                        type="checkbox"
                        class="form-check-input mt-0"
                        [checked]="isSubopcionActiva(mod, so.key)"
                        (change)="toggleSubopcion(mod, so.key, cb.checked)"
                        style="width: 1.2em; height: 1.2em"
                      />
                      <span
                        style="
                          font-family: var(--font-reading);
                          font-size: 0.9rem;
                        "
                      >
                        {{ tituloSub(mod.nombre, so.key) }}
                      </span>
                    </label>
                  </li>
                </ul>
              </div>
            </ng-container>
          </div>

          <div class="p-3">
            <div class="row g-3">
              <div
                [ngClass]="shouldFullWidth(mod, soKey) ? 'col-12' : 'col-md-6'"
                *ngFor="let soKey of subopcionesActivas(mod)"
              >
                <div class="border p-3 bg-white h-100">
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <span class="ing-label-tech text-primary mb-0">{{
                      tituloSub(mod.nombre, soKey)
                    }}</span>
                    <button
                      class="btn btn-link text-danger p-0 text-decoration-none"
                      style="font-family: var(--font-tech); font-size: 0.7rem"
                      (click)="openConfirmRemoveSub(mod, soKey)"
                    >
                      [ QUITAR ]
                    </button>
                  </div>

                  <div class="mb-3 p-2 bg-light border">
                    <small
                      class="ing-label-tech text-muted mb-2"
                      style="font-size: 0.65rem"
                      >EJEMPLOS ORIENTATIVOS</small
                    >
                    <div class="d-flex gap-2 overflow-auto pb-2">
                      <div
                        class="border bg-white p-1 flex-shrink-0 text-center"
                        style="width: 140px"
                        *ngFor="let ej of visibleExamplesFor(mod, soKey)"
                      >
                        <img
                          [src]="ej.src"
                          class="img-fluid object-fit-contain"
                          style="height: 80px"
                          [alt]="'Ejemplo'"
                        />
                        <div
                          class="text-truncate mt-1 text-muted"
                          style="font-size: 0.6rem"
                        >
                          {{ ej.label }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <input
                    #galleryInputsMods
                    type="file"
                    accept="image/*"
                    multiple
                    class="d-none"
                    (change)="onSelectedForSlot($event, mod, soKey)"
                  />
                  <input
                    #cameraInputsMods
                    type="file"
                    accept="image/*"
                    capture="environment"
                    multiple
                    class="d-none"
                    (change)="onSelectedForSlot($event, mod, soKey)"
                  />

                  <div class="ing-dropzone p-3 mb-3">
                    <ng-container
                      *ngIf="
                        !perSlotPreviews[slotKey(mod, soKey)]?.length;
                        else conImagenes
                      "
                    >
                      <div class="text-center py-4">
                        <p
                          class="text-muted mb-1"
                          style="
                            font-family: var(--font-tech);
                            font-size: 0.8rem;
                          "
                        >
                          NO HAY IM츼GENES
                        </p>
                        <small class="d-block mb-3 text-muted">
                          L칤mite: {{ maxImagesForSlot(mod, soKey) }}
                        </small>
                        <div class="d-flex gap-2 justify-content-center">
                          <button
                            type="button"
                            class="btn btn-dark btn-sm btn-ing-action"
                            (click)="openInputForSlot('gallery', mod, soKey)"
                          >
                            Galer칤a
                          </button>
                          <button
                            type="button"
                            class="btn btn-dark btn-sm btn-ing-action"
                            (click)="openInputForSlot('camera', mod, soKey)"
                          >
                            C치mara
                          </button>
                        </div>
                      </div>
                    </ng-container>

                    <ng-template #conImagenes>
                      <div class="w-100">
                        <div
                          class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2"
                        >
                          <span class="ing-badge">
                            {{
                              perSlotPreviews[slotKey(mod, soKey)]?.length || 0
                            }}
                            / {{ maxImagesForSlot(mod, soKey) }}
                          </span>
                          <div class="d-flex gap-2">
                            <button
                              type="button"
                              class="btn btn-outline-dark btn-sm py-0 px-2 rounded-0"
                              (click)="openInputForSlot('gallery', mod, soKey)"
                              [disabled]="
                                (perSlotPreviews[slotKey(mod, soKey)]?.length ||
                                  0) >= maxImagesForSlot(mod, soKey)
                              "
                            >
                              <i class="bi bi-plus-lg"></i> Galer칤a
                            </button>
                            <button
                              type="button"
                              class="btn btn-outline-dark btn-sm py-0 px-2 rounded-0"
                              (click)="openInputForSlot('camera', mod, soKey)"
                              [disabled]="
                                (perSlotPreviews[slotKey(mod, soKey)]?.length ||
                                  0) >= maxImagesForSlot(mod, soKey)
                              "
                            >
                              <i class="bi bi-plus-lg"></i> C치mara
                            </button>
                          </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2">
                          <div
                            class="position-relative border bg-white p-1"
                            style="width: 100px; height: 100px"
                            *ngFor="
                              let prev of perSlotPreviews[slotKey(mod, soKey)];
                              let j = index
                            "
                          >
                            <img
                              [src]="prev"
                              class="w-100 h-100 object-fit-cover"
                              [alt]="'Foto'"
                            />
                            <button
                              type="button"
                              class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0 rounded-0 d-flex align-items-center justify-content-center"
                              style="width: 20px; height: 20px"
                              (click)="removeSlotImage(mod, soKey, j)"
                            >
                              &times;
                            </button>
                          </div>
                        </div>
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="d-flex justify-content-between align-items-center pt-3 border-top"
      >
        <button class="btn btn-ing-outline" (click)="back()">
          <i class="bi bi-arrow-left me-2"></i> Anterior
        </button>
        <button class="btn btn-ing-success" (click)="next()">
          Siguiente <i class="bi bi-arrow-right ms-2"></i>
        </button>
      </div>
    </ng-container>

    <ng-container *ngIf="step === 3">
      <div
        class="alert alert-light border border-dark rounded-0 mb-4 d-flex align-items-center"
      >
        <i class="bi bi-info-circle-fill me-3 fs-4"></i>
        <div>
          <strong class="text-uppercase" style="font-family: var(--font-tech)"
            >Nota Informativa:</strong
          >
          <div class="small">
            No es obligatorio adjuntar documentaci칩n en este paso para
            continuar.
          </div>
        </div>
      </div>

      <div class="row g-4 mb-5">
        <div
          class="col-md-6 col-lg-3"
          *ngFor="
            let doc of [
              'Ficha Tecnica',
              'Permiso De Circulacion',
              'Ticket De Peso',
              'Documentacion Adicional'
            ];
            let i = index
          "
        >
          <div class="ing-card-tech h-100 d-flex flex-column">
            <div class="ing-card-header text-center">
              <span class="ing-label-tech mb-0">{{ doc }}</span>
            </div>

            <div class="p-3 flex-grow-1 d-flex flex-column">
              <div class="bg-light border p-2 mb-3 text-center flex-grow-0">
                <ng-container [ngSwitch]="doc">
                  <div
                    *ngSwitchCase="'Ficha Tecnica'"
                    class="d-flex gap-1 justify-content-center"
                  >
                    <img
                      src="../../../assets/fichatecnica1.png"
                      class="border bg-white"
                      style="height: 60px; object-fit: contain"
                    />
                    <img
                      src="../../../assets/fichatecnica2.png"
                      class="border bg-white"
                      style="height: 60px; object-fit: contain"
                    />
                  </div>
                  <img
                    *ngSwitchCase="'Permiso De Circulacion'"
                    src="../../../assets/permisodecirculacionvehiculo.png"
                    class="border bg-white mx-auto d-block"
                    style="height: 60px; object-fit: contain"
                  />
                  <div
                    *ngSwitchCase="'TicketDe Peso'"
                    class="d-flex gap-1 justify-content-center"
                  >
                    <img
                      src="../../../assets/ticketpeso1.png"
                      class="border bg-white"
                      style="height: 60px; object-fit: contain"
                    />
                    <img
                      src="../../../assets/ticketpeso2.png"
                      class="border bg-white"
                      style="height: 60px; object-fit: contain"
                    />
                  </div>
                </ng-container>
                <small
                  class="d-block mt-1 text-muted"
                  style="font-size: 0.6rem; font-family: var(--font-tech)"
                  >REFERENCIA</small
                >
              </div>

              <div class="d-grid gap-2 mb-2">
                <button
                  class="btn btn-outline-dark btn-sm btn-ing-action"
                  (click)="openInput('gallery', 3, i)"
                >
                  游늭 Galer칤a
                </button>
                <input
                  #galleryInputsDocs
                  type="file"
                  accept="image/*"
                  multiple
                  class="d-none"
                  (change)="onDocSelected($event, doc, 'gallery')"
                />
                <button
                  class="btn btn-outline-dark btn-sm btn-ing-action"
                  (click)="openInput('camera', 3, i)"
                >
                  游닝 C치mara
                </button>
                <input
                  #cameraInputsDocs
                  type="file"
                  accept="image/*"
                  capture="environment"
                  multiple
                  class="d-none"
                  (change)="onDocSelected($event, doc, 'camera')"
                />
              </div>

              <div
                *ngIf="docError[doc]"
                class="alert alert-danger rounded-0 py-1 px-2 mb-2 small text-uppercase font-monospace"
              >
                {{ docError[doc] }}
              </div>

              <div class="ing-dropzone p-2 flex-grow-1">
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                  <div
                    class="position-relative border bg-white"
                    style="width: 60px; height: 60px"
                    *ngFor="
                      let preview of docsPreviews[doc] || [];
                      let j = index
                    "
                  >
                    <img [src]="preview" class="w-100 h-100 object-fit-cover" />
                    <button
                      type="button"
                      class="btn btn-danger p-0 position-absolute top-0 end-0 rounded-0 d-flex align-items-center justify-content-center"
                      style="width: 15px; height: 15px; font-size: 10px"
                      (click)="removeDocImage(doc, j)"
                    >
                      &times;
                    </button>
                  </div>
                  <span
                    *ngIf="!(docsPreviews[doc] && docsPreviews[doc].length)"
                    class="text-muted small align-self-center py-2"
                    style="font-size: 0.7rem"
                    >Vac칤o</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="d-flex justify-content-between align-items-center pt-3 border-top"
      >
        <button class="btn btn-ing-outline" (click)="back()">
          <i class="bi bi-arrow-left me-2"></i> Anterior
        </button>
        <button
          class="btn btn-ing-success d-flex align-items-center gap-2"
          (click)="onSave()"
        >
          Guardar Im치genes <i class="bi bi-check-lg"></i>
        </button>
      </div>
    </ng-container>
  </div>
</div>

<div
  class="modal fade"
  id="modalQuitarReforma"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-0 shadow-lg">
      <div
        class="modal-header rounded-0 text-white"
        [ngClass]="modalAction === 'mod' ? 'bg-danger' : 'bg-warning'"
      >
        <h5
          class="modal-title text-uppercase"
          style="font-family: var(--font-tech)"
        >
          {{
            modalAction === "mod" ? "Eliminar Reforma" : "Eliminar Subselecci칩n"
          }}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body text-center p-4">
        <ng-container *ngIf="modalAction === 'mod'; else subMsg">
          <p class="mb-2">
            Vas a eliminar la siguiente reforma y sus im치genes:
          </p>
          <h5 class="ing-section-title border-bottom-0 mb-0 text-danger">
            {{ modParaQuitar?.nombre }}
          </h5>
        </ng-container>

        <ng-template #subMsg>
          <p class="mb-2">Vas a eliminar la subselecci칩n:</p>
          <h5 class="ing-section-title border-bottom-0 mb-0 text-warning">
            {{ modParaQuitar?.nombre }}
          </h5>
          <p class="fw-bold mt-2">
            {{
              subParaQuitarKey
                ? tituloSub(modParaQuitar?.nombre, subParaQuitarKey)
                : ""
            }}
          </p>
        </ng-template>
      </div>

      <div class="modal-footer justify-content-center bg-light rounded-0">
        <button
          type="button"
          class="btn btn-outline-secondary rounded-0 px-4"
          data-bs-dismiss="modal"
        >
          CANCELAR
        </button>
        <button
          type="button"
          class="btn rounded-0 px-4 fw-bold text-uppercase"
          [ngClass]="modalAction === 'mod' ? 'btn-danger' : 'btn-warning'"
          (click)="confirmRemove()"
          data-bs-dismiss="modal"
        >
          CONFIRMAR
        </button>
      </div>
    </div>
  </div>
</div>
