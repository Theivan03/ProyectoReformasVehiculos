<style>
  /* --- WRAPPER GLOBAL DEL FORMULARIO --- */
  #ing-form-wrapper {
    font-family: "Roboto", sans-serif;
    background-color: #ffffff;
    padding: 2rem;
    border: 1px solid #ced4da;
    max-width: 100%;
  }

  /* Reset de bordes redondeados */
  #ing-form-wrapper * {
    border-radius: 0 !important;
  }

  /* --- TIPOGRAFÍA Y TÍTULOS --- */
  #ing-form-wrapper h4 {
    font-family: "JetBrains Mono", monospace;
    text-transform: uppercase;
    font-weight: 800;
    font-size: 1.5rem;
    color: #000;
    border-bottom: 3px solid #000;
    padding-bottom: 1rem;
    margin-bottom: 2rem;
    letter-spacing: -0.5px;
  }

  #ing-form-wrapper h5 {
    font-family: "JetBrains Mono", monospace;
    text-transform: uppercase;
    font-weight: 700;
    font-size: 1rem;
    color: #000 !important; /* Forzamos negro o gris oscuro */
    background-color: #f8f9fa;
    padding: 0.75rem 1rem;
    border-left: 5px solid #0066ff; /* Acento azul técnico */
    margin-top: 1rem;
    margin-bottom: 1.5rem;
  }

  /* --- INPUTS Y LABELS --- */
  #ing-form-wrapper .form-label {
    font-family: "JetBrains Mono", monospace;
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0.35rem;
    display: block;
  }

  #ing-form-wrapper .form-control,
  #ing-form-wrapper .form-select {
    border: 1px solid #adb5bd;
    font-size: 0.95rem;
    font-weight: 500;
    color: #000;
    padding: 0.6rem 0.8rem;
    transition: all 0.2s;
  }

  #ing-form-wrapper .form-control:focus,
  #ing-form-wrapper .form-select:focus {
    border-color: #000;
    box-shadow: none;
    outline: 1px solid #000;
    background-color: #fff;
  }

  /* Estilo para campos readonly (gris técnico) */
  #ing-form-wrapper .form-control[readonly] {
    background-color: #e9ecef;
    color: #495057;
    border-color: #ced4da;
    font-style: italic;
  }

  /* --- VALIDACIONES --- */
  #ing-form-wrapper .is-invalid {
    border-color: #dc3545 !important;
    background-image: none !important; /* Quitamos icono por defecto de bootstrap */
    border-left: 4px solid #dc3545 !important;
  }

  #ing-form-wrapper .invalid-feedback {
    font-family: "JetBrains Mono", monospace;
    font-size: 0.75rem;
    color: #dc3545;
    margin-top: 0.25rem;
  }

  /* --- ALERTAS --- */
  #ing-form-wrapper .ing-alert {
    background-color: #fff5f5;
    border: 1px solid #dc3545;
    color: #dc3545;
    padding: 1rem;
    font-family: "JetBrains Mono", monospace;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 2rem;
  }

  /* --- BOTONERA DE NAVEGACIÓN --- */
  #ing-form-wrapper .ing-nav-container {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
  }

  #ing-form-wrapper .btn-ing-prev {
    background-color: #fff;
    border: 1px solid #adb5bd;
    color: #6c757d;
    font-family: "JetBrains Mono", monospace;
    text-transform: uppercase;
    font-weight: 600;
    padding: 0.6rem 1.5rem;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
  }

  #ing-form-wrapper .btn-ing-prev:hover {
    border-color: #000;
    color: #000;
    background-color: #f8f9fa;
  }

  #ing-form-wrapper .btn-ing-next {
    background-color: #0066ff;
    border: 1px solid #0066ff;
    color: #fff;
    font-family: "Roboto", sans-serif; /* Roboto Bold para acciones fuertes */
    text-transform: uppercase;
    font-weight: 900;
    letter-spacing: 1px;
    padding: 0.6rem 2rem;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 4px rgba(0, 102, 255, 0.2);
  }

  #ing-form-wrapper .btn-ing-next:hover {
    background-color: #0052cc;
    border-color: #0052cc;
    box-shadow: 0 4px 8px rgba(0, 102, 255, 0.3);
    transform: translateY(-1px);
  }
</style>

<form #formulario="ngForm" (ngSubmit)="enviarFormulario()" novalidate>
  <div id="ing-form-wrapper" class="container mt-4">
    <h4>Formulario de Nueva Reforma</h4>

    <div *ngIf="avisoCargaInvalida" class="ing-alert">
      <i class="bi bi-exclamation-triangle-fill fs-5"></i>
      {{ avisoCargaInvalida }}
    </div>

    <!-- PÁGINA 1 -->
    <ng-container *ngIf="paginaActual === 1">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Número del proyecto *</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="datos.numeroProyecto"
            (ngModelChange)="onNumeroProyectoChange($event)"
            name="numeroProyecto"
            #numeroProyectoField="ngModel"
            required
            [class.is-invalid]="
              numeroProyectoField.invalid && numeroProyectoField.touched
            "
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Referencia del proyecto *</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="datos.referenciaProyecto"
            name="referenciaProyecto"
            #referenciaField="ngModel"
            readonly
            required
            [class.is-invalid]="
              referenciaField.invalid && referenciaField.touched
            "
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Revisión *</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="datos.revision"
            name="revision"
            #revisionField="ngModel"
            required
            [class.is-invalid]="revisionField.invalid && revisionField.touched"
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Taller *</label>
          <select
            class="form-select"
            [(ngModel)]="datos.tallerSeleccionado"
            [compareWith]="compararTalleres"
            name="tallerSeleccionado"
            #tallerField="ngModel"
            required
            [class.is-invalid]="tallerField.invalid && tallerField.touched"
          >
            <option [ngValue]="null" disabled>SELECCIONE UN TALLER</option>
            <option *ngFor="let t of talleres" [ngValue]="t">
              {{ t.nombre }}
            </option>
          </select>
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Ingeniero *</label>
          <select
            class="form-select"
            [(ngModel)]="datos.ingenieroSeleccionado"
            [compareWith]="compararIngenieros"
            name="ingenieroSeleccionado"
            #ingenieroField="ngModel"
            required
            [class.is-invalid]="
              ingenieroField.invalid && ingenieroField.touched
            "
          >
            <option [ngValue]="null" disabled>SELECCIONE UN INGENIERO</option>
            <option *ngFor="let i of ingenieros" [ngValue]="i">
              {{ i.nombre }}
            </option>
          </select>
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Fecha del proyecto *</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="datos.fechaProyecto"
            name="fechaProyecto"
            #fechaProyectoField="ngModel"
            required
            [class.is-invalid]="
              fechaProyectoField.invalid && fechaProyectoField.touched
            "
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">¿Hay reformas previas? *</label>
          <select
            class="form-select"
            [(ngModel)]="datos.reformasPrevias"
            name="reformasPrevias"
            #reformasPreviasField="ngModel"
            required
            [class.is-invalid]="
              reformasPreviasField.invalid && reformasPreviasField.touched
            "
          >
            <option [ngValue]="null" disabled>SELECCIONE UNA OPCIÓN</option>
            <option [ngValue]="false">NO</option>
            <option [ngValue]="true">SÍ</option>
          </select>
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>
      </div>

      <div class="ing-nav-container">
        <button type="button" class="btn btn-ing-prev" (click)="anterior()">
          <i class="bi bi-arrow-left"></i> ANTERIOR
        </button>
        <button type="button" class="btn btn-ing-next" (click)="siguiente()">
          SIGUIENTE <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </ng-container>

    <!-- PÁGINA 2: Datos del vehículo -->
    <ng-container *ngIf="paginaActual === 2">
      <h5>Datos Técnicos del Vehículo</h5>
      <div class="row g-3">
        <div
          class="col-md-4"
          *ngFor="
            let campo of [
              { label: 'Marca', model: 'marca' },
              { label: 'Denominación', model: 'modelo' },
              { label: 'Tipo', model: 'tipo' },
              { label: 'Variante', model: 'variante' },
              { label: 'Versión', model: 'version' },
              { label: 'Matrícula', model: 'matricula' },
              { label: 'Bastidor', model: 'bastidor' },
              {
                label: 'Fecha matriculación',
                model: 'fechaMatriculacion',
                type: 'date'
              },
              { label: 'Contraseña de homologación', model: 'homologacion' },
              {
                label: 'Nombre y apellidos del propietario',
                model: 'propietario'
              },
              { label: 'Categoría', model: 'categoria' },
              { label: 'Clasificación', model: 'clasificacion' }
            ]
          "
        >
          <label class="form-label">{{ campo.label }} *</label>
          <input
            [type]="campo.type || 'text'"
            class="form-control"
            [(ngModel)]="datos[campo.model]"
            [name]="campo.model"
            #ctrl="ngModel"
            required
            [class.is-invalid]="ctrl.invalid && ctrl.touched"
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-12">
          <label class="form-label">Códigos de reforma *</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="datos.codigosReforma"
            name="codigosReforma"
            #codigosReformaField="ngModel"
            readonly
            required
            [class.is-invalid]="
              codigosReformaField.invalid && codigosReformaField.touched
            "
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>
      </div>
      <div class="ing-nav-container">
        <button type="button" class="btn btn-ing-prev" (click)="anterior()">
          <i class="bi bi-arrow-left"></i> ANTERIOR
        </button>
        <button type="button" class="btn btn-ing-next" (click)="siguiente()">
          SIGUIENTE <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </ng-container>

    <!-- PÁGINA 3: Antes de la reforma -->
    <ng-container *ngIf="paginaActual === 3">
      <h5>Especificaciones Previas (Antes de Reforma)</h5>
      <div class="row g-3">
        <div
          class="col-md-4"
          *ngFor="
            let campo of [
              { label: 'Longitud', model: 'longitudAntes' },
              { label: 'Anchura', model: 'anchuraAntes' },
              { label: 'Altura', model: 'alturaAntes' },
              { label: 'Voladizo', model: 'voladizoAntes' },
              { label: 'Vía delantera', model: 'viaDelanteraAntes' },
              { label: 'Vía trasera', model: 'viaTraseraAntes' },
              { label: 'Neumáticos', model: 'neumaticoAntes' },
              { label: 'MOM', model: 'momAntes' },
              { label: 'MMA', model: 'mmaAntes' },
              { label: 'MMA eje 1', model: 'mmaEje1Antes' },
              { label: 'MMA eje 2', model: 'mmaEje2Antes' },
              { label: 'MMA conjunto', model: 'mmaConjuntoAntes' },
              { label: 'Clasificación', model: 'clasificacionAntes' },
              { label: 'Carga vertical', model: 'cargavertical' },
              {
                label: 'MMR remolque con barra de tracción',
                model: 'mmrbarradetraccion'
              },
              { label: 'MMR remolque de eje central', model: 'mmrejecentral' },
              { label: 'MMR remolque sin frenos', model: 'mmrsinfrenos' }
            ]
          "
        >
          <label class="form-label">{{ campo.label }} *</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="datos[campo.model]"
            [name]="campo.model"
            #ctrl="ngModel"
            required
            [class.is-invalid]="ctrl.invalid && ctrl.touched"
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>
      </div>
      <div class="ing-nav-container">
        <button type="button" class="btn btn-ing-prev" (click)="anterior()">
          <i class="bi bi-arrow-left"></i> ANTERIOR
        </button>
        <button type="button" class="btn btn-ing-next" (click)="siguiente()">
          SIGUIENTE <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </ng-container>

    <!-- PÁGINA 4: Después de la reforma -->
    <ng-container *ngIf="paginaActual === 4">
      <h5>Especificaciones Finales (Después de Reforma)</h5>

      <div class="row g-3">
        <!-- Campos generales -->
        <div
          class="col-md-4"
          *ngFor="
            let campo of [
              { label: 'Longitud', model: 'longitudDespues' },
              { label: 'Anchura', model: 'anchuraDespues' },
              { label: 'Altura', model: 'alturaDespues' },
              { label: 'Voladizo', model: 'voladizoDespues' },
              { label: 'Vía delantera', model: 'viaDelanteraDespues' },
              { label: 'Vía trasera', model: 'viaTraseraDespues' },
              { label: 'Neumáticos', model: 'neumaticoDespues' },
              { label: 'Masa real', model: 'masaRealDespues' },
              { label: 'MMA', model: 'mmaDespues' },
              { label: 'MMA eje 1', model: 'mmaEje1Despues' },
              { label: 'MMA eje 2', model: 'mmaEje2Despues' },
              { label: 'MMA conjunto', model: 'mmaConjuntoDespues' },
              { label: 'Clasificación', model: 'clasificacionDespues' },
              { label: 'Carga vertical', model: 'cargaverticalDespues' },
              {
                label: 'MMR remolque con barra de tracción',
                model: 'mmrbarradetraccionDespues'
              },
              {
                label: 'MMR remolque de eje central',
                model: 'mmrejecentralDespues'
              },
              {
                label: 'MMR remolque sin frenos',
                model: 'mmrsinfrenosDespues'
              },
              { label: 'Velocidad máxima', model: 'velocidadMaxima' },
              {
                label: 'Asientos delanteros (sin cond.)',
                model: 'asientosDelanteros'
              },
              { label: 'Asientos 2ª fila', model: 'asientos2Fila' },
              { label: 'Asientos 3ª fila', model: 'asientos3Fila' }
            ]
          "
        >
          <label class="form-label">{{ campo.label }} *</label>

          <input
            type="text"
            class="form-control"
            [(ngModel)]="datos[campo.model]"
            [name]="campo.model"
            #ctrl="ngModel"
            required
            [class.is-invalid]="ctrl.invalid && ctrl.touched"
            (ngModelChange)="
              [
                'masaRealDespues',
                'mmaDespues',
                'mmaEje2Despues',
                'asientosDelanteros',
                'asientos2Fila',
                'asientos3Fila'
              ].includes(campo.model)
                ? comprobarCondicionesCarga()
                : null
            "
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>
      </div>

      <div class="ing-nav-container">
        <button type="button" class="btn btn-ing-prev" (click)="anterior()">
          <i class="bi bi-arrow-left"></i> ANTERIOR
        </button>
        <button type="button" class="btn btn-ing-next" (click)="siguiente()">
          SIGUIENTE <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </ng-container>

    <!-- PÁGINA 5 EXTRA: Control de masas -->
    <ng-container *ngIf="paginaActual === 5 && necesitaPasoExtra">
      <h5>Control de Masas</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Tara total *</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.masaRealDespues"
            name="masaRealDespues"
            #masaRealDespuesField="ngModel"
            required
            [class.is-invalid]="
              masaRealDespuesField.invalid && masaRealDespuesField.touched
            "
          />
        </div>
        <div class="col-md-4">
          <label class="form-label">Tara delante *</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.mmaEje1Despues"
            name="mmaEje1Despues"
            #mmaEje1DespuesField="ngModel"
            required
            [class.is-invalid]="
              mmaEje1DespuesField.invalid && mmaEje1DespuesField.touched
            "
          />
        </div>
        <div class="col-md-4">
          <label class="form-label">Tara detrás *</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.mmaEje2Despues"
            name="mmaEje2Despues"
            #mmaEje2DespuesField="ngModel"
            required
            [class.is-invalid]="
              mmaEje2DespuesField.invalid && mmaEje2DespuesField.touched
            "
          />
        </div>

        <div class="col-md-4">
          <label class="form-label">Distancia entre ejes *</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.distanciaEntreEjes"
            name="distanciaEntreEjes"
            #distanciaEntreEjesField="ngModel"
            required
            [class.is-invalid]="
              distanciaEntreEjesField.invalid && distanciaEntreEjesField.touched
            "
          />
        </div>
        <div class="col-md-4">
          <label class="form-label">Ocupantes adicionales *</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.ocupantesAdicionales"
            name="ocupantesAdicionales"
            #ocupantesAdicionalesField="ngModel"
            required
            [class.is-invalid]="
              ocupantesAdicionalesField.invalid &&
              ocupantesAdicionalesField.touched
            "
          />
        </div>

        <div class="col-md-4">
          <label class="form-label"
            >Distancia CDG eje delantero conductor *</label
          >
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.cdgconductor"
            name="cdgconductor"
            #cdgconductorField="ngModel"
            required
            [class.is-invalid]="
              cdgconductorField.invalid && cdgconductorField.touched
            "
          />
        </div>

        <div class="col-md-4">
          <label class="form-label"
            >Distancia CDG eje delantero Ocup. 2a fila *</label
          >
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.cdgocu2"
            name="cdgocu2"
            #cdgocu2Field="ngModel"
            required
            [class.is-invalid]="cdgocu2Field.invalid && cdgocu2Field.touched"
          />
        </div>

        <div class="col-md-4">
          <label class="form-label"
            >Distancia CDG eje delantero Ocup. 3a fila *</label
          >
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.cdgocu3"
            name="cdgocu3"
            #cdgocu3Field="ngModel"
            required
            [class.is-invalid]="cdgocu3Field.invalid && cdgocu3Field.touched"
          />
        </div>

        <div class="col-md-4">
          <label class="form-label"
            >Distancia CDG eje delantero Carga útil *</label
          >
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.cdgcargautil"
            name="cdgcargautil"
            #cdgcargautilField="ngModel"
            required
            [class.is-invalid]="
              cdgcargautilField.invalid && cdgcargautilField.touched
            "
          />
        </div>

        <div class="col-md-4">
          <label class="form-label"
            >Distancia CDG eje delantero Carga vert. Acopl *</label
          >
          <input
            type="number"
            class="form-control"
            [(ngModel)]="datos.cdgcargavert"
            name="cdgcargavert"
            #cdgcargavertField="ngModel"
            required
            [class.is-invalid]="
              cdgcargavertField.invalid && cdgcargavertField.touched
            "
          />
        </div>
      </div>
      <div class="ing-nav-container">
        <button type="button" class="btn btn-ing-prev" (click)="anterior()">
          <i class="bi bi-arrow-left"></i> ANTERIOR
        </button>
        <button type="button" class="btn btn-ing-next" (click)="siguiente()">
          SIGUIENTE <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </ng-container>

    <!-- PÁGINA 6: Presupuesto -->
    <ng-container *ngIf="paginaActual === totalPaginas">
      <h5>Presupuesto y Costes</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Precio por materiales *</label>
          <input
            type="number"
            min="0"
            step="0.01"
            class="form-control"
            [(ngModel)]="datos.materialesUsados"
            (ngModelChange)="limitarDecimales('materialesUsados', $event)"
            name="materialesUsados"
            #matField="ngModel"
            required
            [class.is-invalid]="matField.invalid && matField.touched"
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Precio por mano de obra *</label>
          <input
            type="number"
            min="0"
            step="0.01"
            class="form-control"
            [(ngModel)]="datos.manoDeObra"
            (ngModelChange)="limitarDecimales('manoDeObra', $event)"
            name="manoDeObra"
            #moField="ngModel"
            required
            [class.is-invalid]="moField.invalid && moField.touched"
          />
          <div class="invalid-feedback">CAMPO OBLIGATORIO</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Total presupuesto *</label>
          <input
            type="number"
            min="0"
            step="0.01"
            class="form-control"
            [value]="datos.totalPresupuesto?.toFixed(2)"
            name="totalPresupuesto"
            readonly
          />
        </div>
      </div>
      <div class="ing-nav-container">
        <button type="button" class="btn btn-ing-prev" (click)="anterior()">
          <i class="bi bi-arrow-left"></i> ANTERIOR
        </button>
        <button
          type="button"
          class="btn btn-ing-next"
          (click)="enviarFormulario()"
        >
          CONTINUAR <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </ng-container>
  </div>
</form>
