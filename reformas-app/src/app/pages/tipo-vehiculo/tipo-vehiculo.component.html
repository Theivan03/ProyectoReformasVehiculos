<div class="container mt-4">
  <div class="card p-4 shadow-sm">
    <h4 class="mb-3">Tipo de Vehículo</h4>

    <!-- Selector tipo vehículo -->
    <div class="mb-3">
      <label class="form-label">Seleccione el tipo de vehículo:</label>
      <select
        class="form-select"
        [(ngModel)]="tipoVehiculo"
        (change)="onTipoCambio()"
        [class.is-invalid]="tipoVehiculoInvalido"
      >
        <option [ngValue]="null" disabled selected>-- Seleccionar --</option>
        <option value="coche">Coche</option>
        <option value="moto">Moto</option>
        <option value="camper">Camper</option>
        <option value="industrial">Industrial</option>
      </select>
      <div class="invalid-feedback">Debe seleccionar un tipo de vehículo.</div>
    </div>

    <!-- Lista de modificaciones -->
    <div *ngIf="modificaciones.length > 0" class="mt-4">
      <h5 class="mb-3">Modificaciones aplicables</h5>
      <div *ngFor="let mod of modificaciones; let i = index" class="mb-3">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            [(ngModel)]="mod.seleccionado"
            [id]="'mod-' + i"
          />
          <label class="form-check-label" [for]="'mod-' + i">
            {{ mod.nombre }}
          </label>
        </div>

        <!-- Muelles -->
        <div
          *ngIf="mod.nombre.includes('MUELLES') && mod.seleccionado"
          class="mt-2 ms-4"
        >
          <label class="form-label">¿Qué elementos se han modificado?</label>
          <div
            class="form-check"
            *ngFor="let item of detallesMuellesOpciones; let idx = index"
          >
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detallesMuelles![item.key]"
              (ngModelChange)="actualizarError(idx, mod)"
              id="detalle-muelle-{{ idx }}"
              name="detalle-muelle-{{ idx }}"
            />
            <label class="form-check-label" for="detalle-muelle-{{ idx }}">
              {{ item.label }}
            </label>
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>

          <label class="form-label mt-3"
            >¿Desea añadir la anotación de no modificación de dirección?</label
          >
          <select
            class="form-select"
            [(ngModel)]="mod.anotacion"
            (ngModelChange)="actualizarError(i, mod)"
          >
            <option [ngValue]="null" disabled selected>
              -- Seleccionar --
            </option>
            <option value="1">Sí</option>
            <option value="2">No</option>
          </select>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- Neumáticos -->
        <div
          *ngIf="mod.nombre === 'NEUMÁTICOS' && mod.seleccionado"
          class="ms-4 mt-2"
        >
          <label class="form-label">Seleccione anotaciones si procede:</label>

          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.anotacion1"
              (ngModelChange)="actualizarError(i, mod)"
              id="anotacion1{{ i }}"
            />
            <label class="form-check-label" for="anotacion1{{ i }}"
              >Diferencia superior al 8%</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.anotacion2"
              (ngModelChange)="actualizarError(i, mod)"
              id="anotacion2{{ i }}"
            />
            <label class="form-check-label" for="anotacion2{{ i }}"
              >Índice de velocidad menor del original</label
            >
          </div>
        </div>

        <!-- INTERMITENTES -->
        <div
          *ngIf="mod.nombre === 'INTERMITENTES' && mod.seleccionado"
          class="ms-4"
        >
          <label class="form-label"
            >Seleccione la posicion de los intermitentes:</label
          >
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.interDelantero"
              (ngModelChange)="actualizarError(i, mod)"
              id="interDelantero{{ i }}"
            />
            <label class="form-check-label" for="interDelantero{{ i }}"
              >Delanteros</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.interTrasero"
              (ngModelChange)="actualizarError(i, mod)"
              id="interTrasero{{ i }}"
            />
            <label class="form-check-label" for="interTrasero{{ i }}"
              >Traseros</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.interLateral"
              (ngModelChange)="actualizarError(i, mod)"
              id="interLateral{{ i }}"
            />
            <label class="form-check-label" for="interLateral{{ i }}"
              >Laterales</label
            >
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- SUSTITUCIÓN DE EJES -->
        <div
          *ngIf="mod.nombre === 'SUSTITUCIÓN DE EJES' && mod.seleccionado"
          mod.detalle
          class="ms-4"
        >
          <label class="form-label">Seleccione el/los ejes:</label>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.sustitucionEjeDelantero"
              (ngModelChange)="actualizarError(i, mod)"
              id="sustitucionEjeDelantero{{ i }}"
            />
            <label class="form-check-label" for="sustitucionEjeDelantero{{ i }}"
              >Delantero</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle!.sustitucionEjeTrasero"
              (ngModelChange)="actualizarError(i, mod)"
              id="sustitucionEjeTrasero{{ i }}"
            />
            <label class="form-check-label" for="sustitucionEjeTrasero{{ i }}"
              >Trasero</label
            >
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- ESTRIBOS LATERALES O TALONERAS -->
        <div
          *ngIf="
            mod.nombre === 'ESTRIBOS LATERALES O TALONERAS' && mod.seleccionado
          "
          class="ms-4 mt-2"
        >
          <label class="form-label">Seleccione cuál instaló:</label>
          <select
            class="form-select mb-1"
            [(ngModel)]="mod.estribosotaloneras"
            (ngModelChange)="validarSubopciones()"
            [class.is-invalid]="erroresSubopciones[i]"
            name="estribosotaloneras{{ i }}"
            [ngModelOptions]="{ standalone: true }"
          >
            <option [ngValue]="null" disabled>-- Seleccionar --</option>
            <option value="estribos">Estribos</option>
            <option value="taloneras">Taloneras</option>
          </select>

          <label class="form-label">¿Material antideslizante?</label>
          <select
            class="form-select mb-1"
            [(ngModel)]="mod.anotacionAntideslizante"
            (ngModelChange)="validarSubopciones()"
            [class.is-invalid]="erroresSubopciones[i]"
            name="anotacionAntideslizante{{ i }}"
            [ngModelOptions]="{ standalone: true }"
          >
            <option [ngValue]="null" disabled>-- Seleccionar --</option>
            <option value="1">Sí</option>
            <option value="2">No</option>
          </select>

          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debes escoger ambas opciones antes de continuar.
          </div>
        </div>

        <!-- Aletines -->
        <div
          *ngIf="
            mod.nombre.includes('ALETINES') && mod.seleccionado && mod.detalle
          "
          class="ms-4"
        >
          <label class="form-label">Seleccione el tipo:</label>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle.aletines"
              (ngModelChange)="actualizarError(i, mod)"
              id="aletines{{ i }}"
            />
            <label class="form-check-label" for="aletines{{ i }}"
              >Aletines</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.detalle.sobrealetines"
              (ngModelChange)="actualizarError(i, mod)"
              id="sobrealetines{{ i }}"
            />
            <label class="form-check-label" for="sobrealetines{{ i }}"
              >Sobrealetines</label
            >
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- Matrícula -->
        <div
          *ngIf="
            mod.nombre.includes('MATRÍCULA') && mod.seleccionado && mod.detalle
          "
          class="ms-4"
        >
          <label class="form-label">Modificación de matrícula:</label>

          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="instalacionPorta{{ i }}"
              [(ngModel)]="mod.detalle.instalacionPorta"
              name="instalacionPorta{{ i }}"
            />
            <label class="form-check-label" for="instalacionPorta{{ i }}">
              Portamatrículas trasero
            </label>
          </div>

          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="reubicacionTrasera{{ i }}"
              [(ngModel)]="mod.detalle.reubicacionTrasera"
              name="reubicacionTrasera{{ i }}"
            />
            <label class="form-check-label" for="reubicacionTrasera{{ i }}">
              Reubicación matrícula trasera
            </label>
          </div>

          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="cambioUbicacionDelantera{{ i }}"
              [(ngModel)]="mod.detalle.cambioUbicacionDelantera"
              name="cambioUbicacionDelantera{{ i }}"
            />
            <label
              class="form-check-label"
              for="cambioUbicacionDelantera{{ i }}"
            >
              Cambio ubicación matrícula delantera
            </label>
          </div>

          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- Piloto trasero -->
        <div
          *ngIf="
            mod.nombre.includes('PILOTO TRASERO') &&
            mod.seleccionado &&
            mod.detalle
          "
          class="ms-4"
        >
          <label class="form-label">¿Qué elementos va a sustituir?</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="luzPosYFreno{{ i }}"
              [(ngModel)]="mod.detalle.luzPosicionFreno"
              name="luzPosicionFreno{{ i }}"
              (change)="actualizarError(i, mod)"
            />
            <label class="form-check-label" for="luzPosYFreno{{ i }}">
              Luz de posición y freno
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="intermitente{{ i }}"
              [(ngModel)]="mod.detalle.intermitente"
              name="intermitente{{ i }}"
              (ngModelChange)="actualizarError(i, mod)"
            />
            <label class="form-check-label" for="intermitente{{ i }}">
              Intermitente
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="marchaAtras{{ i }}"
              [(ngModel)]="mod.detalle.marchaAtras"
              name="marchaAtras{{ i }}"
              (ngModelChange)="actualizarError(i, mod)"
            />
            <label class="form-check-label" for="marchaAtras{{ i }}">
              Marcha atrás
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="catadioptrico{{ i }}"
              [(ngModel)]="mod.detalle.catadioptrico"
              name="catadioptrico{{ i }}"
              (ngModelChange)="actualizarError(i, mod)"
            />
            <label class="form-check-label" for="catadioptrico{{ i }}">
              Catadióptrico
            </label>
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- Mueble camper -->
        <div
          *ngIf="
            mod.nombre === 'MOBILIARIO INTERIOR VEHÍCULO' &&
            mod.seleccionado &&
            mod.opcionesMueble
          "
          class="ms-4"
        >
          <label class="form-label">¿Qué tipo de mueble desea indicar?</label>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.opcionesMueble.muebleBajo"
              id="muebleBajo{{ i }}"
            />
            <label class="form-check-label" for="muebleBajo{{ i }}"
              >Mueble bajo</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.opcionesMueble.muebleAlto"
              id="muebleAlto{{ i }}"
            />
            <label class="form-check-label" for="muebleAlto{{ i }}"
              >Mueble alto</label
            >
          </div>
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="mod.opcionesMueble.aseo"
              id="aseo{{ i }}"
            />
            <label class="form-check-label" for="aseo{{ i }}">Aseo</label>
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- Instalación eléctrica camper -->
        <div
          *ngIf="mod.nombre === 'INSTALACIÓN ELÉCTRICA' && mod.seleccionado"
          class="ms-4"
        >
          <label class="form-label">¿Desea añadir anotación?</label>
          <select class="form-select" [(ngModel)]="mod.anotacion">
            <option [ngValue]="null" disabled selected>
              -- Seleccionar --
            </option>
            <option [ngValue]="true">Sí</option>
            <option [ngValue]="false">No</option>
          </select>
        </div>

        <!-- Aumento o disminución de plazas -->
        <div
          *ngIf="
            mod.nombre === 'AUMENTO O DISMINUCIÓN DE PLAZAS' && mod.seleccionado
          "
          class="ms-4"
        >
          <label class="form-label">Tipo de modificación:</label>
          <select class="form-select" [(ngModel)]="mod.tipoCambio">
            <option [ngValue]="null" disabled selected>
              -- Seleccionar --
            </option>
            <option value="aumento">Aumento</option>
            <option value="disminucion">Disminución</option>
          </select>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- MMA/MMTA moto -->
        <div
          *ngIf="mod.nombre === 'REDUCCIÓN MMA Y MMTA' && mod.seleccionado"
          class="ms-4"
        >
          <label class="form-label">¿Qué se modifica?</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.ejeDelantero"
              id="ejeDelantero{{ i }}"
            />
            <label class="form-check-label" for="ejeDelantero{{ i }}"
              >Reducción en eje delantero</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.ejeTotal"
              id="ejeTotal{{ i }}"
            />
            <label class="form-check-label" for="ejeTotal{{ i }}"
              >Reducción total</label
            >
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- Guardabarros -->
        <div
          *ngIf="mod.nombre === 'SUSTITUCIÓN GUARDABARROS' && mod.seleccionado"
          class="ms-4"
        >
          <label class="form-label">¿Qué guardabarros se ha sustituido?</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.guardabarrosDelantero"
              id="guardabarrosDelantero{{ i }}"
            />
            <label class="form-check-label" for="guardabarrosDelantero{{ i }}"
              >Delantero</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.guardabarrosTrasero"
              id="guardabarrosTrasero{{ i }}"
            />
            <label class="form-check-label" for="guardabarrosTrasero{{ i }}"
              >Trasero</label
            >
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- Disco y pastilla de freno -->
        <div
          *ngIf="
            mod.nombre === 'DISCO DE FRENO Y PINZA DE FRENO' && mod.seleccionado
          "
          class="ms-4"
        >
          <label class="form-label"
            >¿Qué componente de freno se ha modificado?</label
          >
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.tieneDisco"
              id="ejeDelantero{{ i }}"
            />
            <label class="form-check-label" for="ejeDelantero{{ i }}"
              >Disco de freno</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              [(ngModel)]="mod.tienePastilla"
              id="tienePastilla{{ i }}"
            />
            <label class="form-check-label" for="tienePastilla{{ i }}"
              >Pastilla de freno</label
            >
          </div>
          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>

        <!-- Luces -->
        <div
          *ngIf="mod.nombre === 'LUCES' && mod.seleccionado"
          class="mt-3 ms-4 border-start ps-3"
        >
          <label class="form-label">
            ¿Qué modificaciones se han hecho en luces?
          </label>

          <div
            class="form-check mb-1"
            *ngFor="let item of opcionesDescripcionLuces; let i = index"
          >
            <input
              type="checkbox"
              class="form-check-input"
              id="luces-{{ i }}"
              [(ngModel)]="mod.descripcionLuces![item.key]"
            />
            <label class="form-check-label" [for]="'luces-' + i">
              {{ item.label }}
            </label>
          </div>

          <div *ngIf="erroresSubopciones[i]" class="text-danger mt-1">
            Debe seleccionar al menos una opción en este bloque.
          </div>
        </div>
      </div>
    </div>

    <!-- Botones -->
    <div class="d-flex justify-content-between mt-4">
      <button class="btn btn-outline-secondary" (click)="volverFormulario()">
        ← Volver
      </button>
      <button class="btn btn-primary" (click)="continuarFormulario()">
        Continuar →
      </button>
    </div>
  </div>
</div>
